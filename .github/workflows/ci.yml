name: CI â€“ Build, Lint, Test + Deploy to AWS S3

on:
  pull_request:
    branches: [develop, main]
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write
  packages: write
  security-events: write

jobs:
  # ğŸ§± Bygg, lint, test + bygg Docker-image vid PR till develop
  setup-and-build:
    if: github.base_ref == 'develop'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./desktop

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22

      - run: npm ci
      - run: npm run lint
      - run: npm test
      - run: npm run build

      # ğŸ”¥ Logga in i GHCR
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # ğŸ³ Bygg Docker-image baserat pÃ¥ PR-nummer
      - name: Build Docker image
        run: |
          IMAGE_NAME="ghcr.io/${{ github.repository }}:pr-${{ github.event.pull_request.number }}"
          IMAGE_NAME_LOWER=$(echo "$IMAGE_NAME" | tr '[:upper:]' '[:lower:]')
          echo "IMAGE_NAME_LOWER=$IMAGE_NAME_LOWER" >> $GITHUB_ENV
          docker build -t "$IMAGE_NAME_LOWER" .
          docker push "$IMAGE_NAME_LOWER"


      # ğŸ“¦ Push image
      - name: Push Docker image
        run: docker push ghcr.io/${{ github.repository }}:pr-${{ github.event.pull_request.number }}


  # ğŸ”„ Tagga som latest nÃ¤r PR mergas in i main
  tag-latest:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # â¬‡ï¸ HÃ¤mta image taggad med PR-numret
      - name: Pull PR image
        run: |
          docker pull ghcr.io/${{ github.repository }}:pr-${{ github.event.number }}

      # ğŸ·ï¸ Tagga om som latest
      - name: Tag as latest
        run: |
          docker tag ghcr.io/${{ github.repository }}:pr-${{ github.event.number }} \
                     ghcr.io/${{ github.repository }}:latest

      # ğŸ“¦ Push latest
      - name: Push latest
        run: docker push ghcr.io/${{ github.repository }}:latest


  # ğŸš€ Deploy â€“ kÃ¶rs nÃ¤r PR gÃ¥r till main eller nÃ¤r main fÃ¥r en push
  deploy:
    if: github.ref == 'refs/heads/main' || github.base_ref == 'main'
    needs: tag-latest
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./desktop

    steps:
      - uses: actions/checkout@v4

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # ğŸ³ HÃ¤mta latest-image
      - name: Pull Docker image
        run: docker pull ghcr.io/${{ github.repository }}:latest

      # ğŸ“¦ Extrahera dist frÃ¥n containern
      - name: Extract dist from image
        run: |
          id=$(docker create ghcr.io/${{ github.repository }}:latest)
          docker cp $id:/app/dist ./dist
          docker rm $id

      # ğŸ” AWS login
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-north-1

      # â˜ï¸ Deploy till S3
      - name: Deploy to S3
        uses: jakejarvis/s3-sync-action@v0.5.1
        with:
          args: --follow-symlinks --delete
        env:
          AWS_S3_BUCKET: trackapp-frontend
          SOURCE_DIR: dist
